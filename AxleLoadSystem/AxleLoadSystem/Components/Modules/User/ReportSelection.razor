@inject IStationService stationService
@inject IWIMScaleService wimService
@inject IConfiguration configuration
@inject IClassStatusService classStatusService
@using BOL.CustomModels
@using Syncfusion.Blazor.Calendars
@rendermode InteractiveServer

<div class="card">
    <div class="card-body">
        @if (selectionEnabled && reportParameters is not null)
        {
            <div class="row">
                <div class="col-md-12">
                    @if (stations is not null)
                    {
                        <div class="btn-group">
                            @foreach (Station item in stations.OrderBy(s => s.StationName))
                            {
                                @if (selectedStations is not null && selectedStations.Any(s => s.StationId == item.StationId))
                                {
                                    <span class="btn btn-primary" @onclick="@(() => StationClicked(item))">
                                        <i class="fas fa-check-square"></i><span class="ms-2">&nbsp; @item.StationName</span>
                                    </span>
                                }
                                else
                                {
                                    <span class="btn btn-outline-primary" @onclick="@(() => StationClicked(item))">
                                        <i class="fas fa-square"></i><span class="ms-2">&nbsp; @item.StationName</span>
                                    </span>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <Loader />
                    }
                </div>

                @if (wims is not null && wims.Count() > 0)
                {
                    <div class="col-md-6">
                        <label>List of WIM Scale Information</label>
                        <select class="form-control" @bind="@reportParameters.SelectedWIMScaleId">
                            <option value="0">-Select WIM-</option>
                            @foreach (WIMScale item in wims)
                            {
                                <option value="@item.Id">@item.LaneNumber - @item.LaneDirection</option>
                            }
                        </select>
                    </div>
                }
                <div class="col-md-6">
                    <label>Select Date Range </label>
                    <SfDateRangePicker TValue="DateTime?" StartDate="@reportParameters.DateStart" EndDate="@reportParameters.DateEnd">
                        <DateRangePickerEvents TValue="DateTime?" ValueChange="@OnDateRangeChanged"></DateRangePickerEvents>
                    </SfDateRangePicker>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <label>Number of Axles</label>
                    <select class="form-control" @bind="@reportParameters.NumberOfAxle">
                        <option value="0">-No Filter-</option>
                        @for (int i = 2; i <= MaxNoOfAxle; i++)
                        {
                            <option value="@i">@i Axle</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Weight Filter Column</label>
                    <select class="form-control" @bind="@reportParameters.WeightFilterColumn">
                        <option value="0">-No Filter-</option>
                        <option value="GrossVehicleWeight">Gross Vehicle Weight</option>
                        <option value="Axle1">Axle1</option>
                        <option value="Axle2">Axle2</option>
                        <option value="Axle3">Axle3</option>
                        <option value="Axle4">Axle4</option>
                        <option value="Axle5">Axle5</option>
                        <option value="Axle6">Axle6</option>
                        <option value="Axle7">Axle7</option>
                        <option value="AxleRemaining">AxleRemaining</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Class Status</label>
                    <select class="form-control" @bind="@reportParameters.ClassStatus">
                        <option value="0">-No Filter-</option>
                        @foreach (ClassStatus status in ListClassStatus)
                        {
                            <option value="@status.Id">@status.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" @bind="reportParameters.IsOverloaded" id="chkIsOverloaded" />
                        <label class="form-check-label" for="chkIsOverloaded">Overloaded?</label>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="wheelBase">Wheel Base</label>
                    <input type="number" @bind="@reportParameters.Wheelbase" class="form-control" placeholder="Wheel Base" id="wheelBase" min="0" max="100" />
                </div>
                <div class="col-md-3">
                    <label for="WeightMin">Weight Minimum</label>
                    <input type="number" @bind="@reportParameters.WeightMin" class="form-control" placeholder="Weight Minimum" id="WeightMin" min="0" />
                </div>
                <div class="col-md-3">
                    <label for="WeightMax">Weight Maximum</label>
                    <input type="number" @bind="@reportParameters.WeightMax" class="form-control" placeholder="Weight Maximum" id="WeightMax" min="0" />
                </div>
                <div class="col-md-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" @bind="reportParameters.CheckWeightCalculation" id="CheckWeightCalculation" />
                        <label class="form-check-label" for="CheckWeightCalculation">Check Weight Calculation?</label>
                    </div>
                </div>
            </div>               
        }
        else
        {
            <div class="row">
                <div class="col">
                    <label>@selectedStations?.Count() station(s) selected </label>
                    @foreach (Station item in selectedStations ?? new())
                    {
                        <span class="badge badge-primary">@item.StationName</span>
                    }
                    @if (reportParameters.SelectedWIMScaleId > 0)
                    {
                        <label>, WIM Scale <span class="badge badge-primary">@reportParameters.SelectedWIMScaleId</span> selected</label>
                    }
                    @* <label>, Date range @reportParameters.DateStart to @reportParameters.DateEnd</label>
                     *@
                    @if (reportParameters.NumberOfAxle > 0)
                    {
                        <label>, Axle <span class="badge badge-primary">@reportParameters.NumberOfAxle</span> selected</label>
                    }
                    @if (reportParameters.WeightFilterColumn is not null)
                    {
                        <label>, Weight Filter Column <span class="badge badge-primary">@reportParameters.WeightFilterColumn</span> selected</label>
                    }
                    @if (reportParameters.ClassStatus > 0)
                    {
                        string name = ListClassStatus.Where(l => l.Id == reportParameters.ClassStatus).FirstOrDefault().Name.ToString();
                        <label>, <span class="badge badge-primary">@name</span> selected</label>
                    }
                    @if (reportParameters.IsOverloaded)
                    {
                        <label>, <span class="badge badge-primary">Overloaded</span> selected</label>
                    }
                    @if (reportParameters.Wheelbase > 0)
                    {
                        <label>, <span class="badge badge-primary">@reportParameters.Wheelbase</span> Wheelbase selected</label>
                    }
                    @if (reportParameters.WeightMin > 0)
                    {
                        <label>, <span class="badge badge-primary">@reportParameters.WeightMin</span> Weight Minimum selected</label>
                    }
                    @if (reportParameters.WeightMax > 0)
                    {
                        <label>, <span class="badge badge-primary">@reportParameters.WeightMax</span> Weight Maximum selected</label>
                    }
                    @if (reportParameters.CheckWeightCalculation)
                    {
                        <label>, <span class="badge badge-primary">Check Weight Calculation</span> selected.</label>
                    }
                </div>
            </div>
            @if (selectedStations is not null)
            {
                <div class="row">
                    <div class="col-md-6 btn-group">
                        <span class="btn @(selectedType == "Daily" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Daily"))">Daily</span>
                        <span class="btn @(selectedType == "Weekly" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Weekly"))">Weekly</span>
                        <span class="btn @(selectedType == "Monthly" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Monthly"))">Monthly</span>
                        <span class="btn @(selectedType == "Quarterly" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Quarterly"))">Quarterly</span>
                        <span class="btn @(selectedType == "SemiAnnual" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("SemiAnnual"))">Semi Annual</span>
                        <span class="btn @(selectedType == "Annual" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Annual"))">Annual</span>
                    </div>
                </div>
            }
        }
    </div>
    <div class="card-footer">
        <button class="btn btn-primary" @onclick="SelectionComplete">Change</button>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<ReportParameters?> OnParametersChanged { get; set; }

    private IEnumerable<Station>? stations;
    private List<Station>? selectedStations;
    private IEnumerable<ClassStatus> ListClassStatus { get; set; }
    private IEnumerable<WIMScale>? wims;
    private int MaxNoOfAxle { get; set; } 
    private bool selectionEnabled { get; set; } = false;
    private int wimId { get; set; } = 0;
    private string selectedType { get; set; } = "Daily";

    private ReportParameters reportParameters { get; set; } = new();
    private (DateTime? StartDate, DateTime? EndDate)? selectedDateRange;

    protected override async Task OnInitializedAsync()
    {
        stations = await stationService.Get();
        ListClassStatus = await classStatusService.GetClassStatusList();
        MaxNoOfAxle = Convert.ToInt32(configuration.GetSection("CustomSettings:MaxNoOfAxle").Value);
        reportParameters.DateEnd = DateTime.Today;
        reportParameters.DateStart = DateTime.Now.AddYears(-10);
    }
    private async Task StationClicked(Station item)
    {
        if (selectedStations is null)
        {
            selectedStations = new();
        }
        if (selectedStations.Any(s => s.StationId == item.StationId))
        {
            selectedStations.Remove(item);
        }
        else
        {
            selectedStations.Add(item);
        }

        if (selectedStations.Count() == 1)
        {
            wims = await wimService.GetByStation(new WIMScale() { StationId = item.StationId });
            if (wims is not null && wims.Count() == 1)
            {
                wimId = wims.FirstOrDefault().Id;
            }
        }
        else
        {
            wims = null;
            reportParameters.SelectedWIMScaleId = 0;
        }
    }
    private async Task OnDateRangeChanged(RangePickerEventArgs<DateTime?> args)
    { 
        reportParameters.DateStart = args.StartDate ?? DateTime.Now;
        reportParameters.DateEnd = args.EndDate ?? DateTime.Now;  
    }
    private async Task SelectionComplete()
    {
        selectionEnabled = !selectionEnabled;
        if (selectedStations is not null)
        {
            reportParameters.SelectedStation = selectedStations.FirstOrDefault();
            await OnParametersChanged.InvokeAsync(reportParameters);
        }
    }
    private void StationSelected(List<Station> selectedStations)
    {

    }
    private void TypeChanged(string type)
    {
        selectedType = type;
    }
}
