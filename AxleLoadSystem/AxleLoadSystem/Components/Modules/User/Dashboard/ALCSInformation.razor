@using Syncfusion.Blazor
@using Syncfusion.Blazor.Charts
@inject IStationService stationService
@inject IFileService fileService
@inject IAxleLoadService loadService
@inject IAppState appState

<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">ALCS Information</h3>
    </div>
    <div class="card-body">
        @if (Station is null)
        {
            <Loader />
        }
        else
        {
            <div class="row">
                <div class="col-12">
                    <table class="table">
                        <tr>
                            <td>ALCS</td>
                            <td>@Station.StationName</td>
                        </tr>
                        <tr>
                            <td>Address</td>
                            <td>@Station.Address</td>
                        </tr>
                        @if (files is not null && files.Any())
                        {
                            <tr>
                                <td>Last file uploaded</td>
                                <td>@files.Max(f => f.Date).ToString("dd MMM yy")</td>
                            </tr>
                            <tr>
                                <td>Total Files uploaded</td>
                                <td>@files.Count().ToString("N0")</td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td>Last file uploaded</td>
                                <td>NA</td>
                            </tr>
                            <tr>
                                <td>Total Files uploaded</td>
                                <td>0</td>
                            </tr>
                        }
                    </table>
                    @if (!string.IsNullOrEmpty(Summary))
                    {
                        <label class="text-danger">@Summary</label>
                    }
                </div>
                <div class="col-12">
                    @if (loadCounts is null)
                    {
                        <Loader />
                    }
                    else if (loadCounts.Count() == 0)
                    {
                        <p>No Data Found</p>
                    }
                    else
                    {
                        <div class="col-md-12 col-sm-12">
                            <label class="text"> Data Analysis Chart</label>
                            <div class="col-md-12 btn-group">
                                <button class="btn @(selectedType == "Today" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Today"))">Today</button>
                                <button class="btn @(selectedType == "Yesterday" ? "btn-danger" : "btn-primary")" @onclick="@(() => TypeChanged("Yesterday"))">Yesterday</button>
                            </div>
                            <br/>
                            @if (chartview)
                            {
                                <div class="col-md-12 col-sm-12">
                                    <SfChart @ref="@chartInstance" Title="@ChartTitle" Width="@Width" Theme="@Theme">
                                        <ChartArea><ChartAreaBorder Width="0"></ChartAreaBorder></ChartArea>

                                        <ChartPrimaryXAxis Title="@YAxisTitle" ValueType="Syncfusion.Blazor.Charts.ValueType.Category" Interval="1">
                                            <ChartAxisMajorGridLines Width="0"></ChartAxisMajorGridLines>
                                            <ChartAxisMinorGridLines Width="0"></ChartAxisMinorGridLines>
                                        </ChartPrimaryXAxis>

                                        <ChartPrimaryYAxis Title="@XAxisTitle">
                                            <ChartAxisMinorGridLines Width="1"></ChartAxisMinorGridLines>
                                        </ChartPrimaryYAxis>

                                        <ChartSeriesCollection>
                                            <ChartSeries Name="Overloaded Vehicles" ColumnWidth="0.5" DataSource="@ChartData" XName="DateUnitName" YName="OverloadVehicle" Width="2" Type="chartSeriesType" EnableTooltip="true">
                                                <ChartMarker>
                                                    <ChartDataLabel Visible="true" Position="LabelPosition.Top">
                                                        <ChartDataLabelFont FontWeight="600" Color="#ffffff"></ChartDataLabelFont>
                                                    </ChartDataLabel>
                                                </ChartMarker>
                                                <ChartSeriesBorder Width="1" Color="#ffffff"></ChartSeriesBorder>
                                            </ChartSeries>

                                            <ChartSeries Name="Not-Overloaded Vehicles" ColumnWidth="0.5" DataSource="@ChartData" XName="DateUnitName" YName="TotalVehicle" Width="2" Type="chartSeriesType" EnableTooltip="true">
                                                <ChartMarker>
                                                    <ChartDataLabel Visible="true" Position="LabelPosition.Top">
                                                        <ChartDataLabelFont FontWeight="600" Color="#ffffff"></ChartDataLabelFont>
                                                    </ChartDataLabel>
                                                </ChartMarker>
                                                <ChartSeriesBorder Width="1" Color="#ffffff"></ChartSeriesBorder>
                                            </ChartSeries>
                                        </ChartSeriesCollection>
                                        <ChartTooltipSettings Enable="true"></ChartTooltipSettings>
                                        <ChartLegendSettings Visible="true" EnableHighlight="true"></ChartLegendSettings>
                                    </SfChart>
                                </div>
                                
                            }
                        </div>
                    }
                </div>              
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Station Station { get; set; }

    private IEnumerable<UploadedFile> files { get; set; }
    private IEnumerable<AxleLoadCount> loadCounts { get; set; } = null;

    private (IEnumerable<AxleLoadReport>, bool, string) report { get; set; }
    private Theme Theme { get; set; } = 0;
    private SfChart chartInstance;
    public LabelIntersectAction Label { get; set; } = LabelIntersectAction.Trim;
    public IEnumerable<AxleLoadReport> ChartData { get; set; }
    private ChartSeriesType chartSeriesType { get; set; } = ChartSeriesType.StackingColumn;
    public string Width { get; set; } = "100%";
    public string FileName { get; set; } = "Charts";
    public string Format { get; set; } = "{value} GW";
    public string ChartTitle { get; set; } = "";
    public string XAxisTitle { get; set; } = "";
    public string YAxisTitle { get; set; } = "";
    private string Summary { get; set; } = "";
    private string selectedType { get; set; } 
    private ReportParameters reportParameters { get; set; } = new();
    private bool chartview { get; set; } = false;
    private bool redrawPaths = true;
    private bool animate = false;

    protected override async Task OnParametersSetAsync()
    {
        files = await fileService.Get(Station.StationId);
        loadCounts = await loadService.GetDateWiseCount(Station, DateTime.Today.AddMonths(-1), DateTime.Today.AddDays(-1));
        await TypeChanged("Today");
    }
    private async Task TypeChanged(string type)
    {
        if (type.ToLower() == "today")
        {
            selectedType = type;
            reportParameters.DateStart = DateTime.Now.Date;
            reportParameters.DateEnd = DateTime.Now.AddDays(+1);

        }
        else if (type.ToLower() == "yesterday")
        {
            selectedType = type;
            reportParameters.DateStart = DateTime.Now.AddDays(-1);
            reportParameters.DateEnd = DateTime.Now;
        }
        await LoadChart();
        chartview = true;
    }
    private async Task LoadChart()
    {
        if (Station.StationId > 0 && !reportParameters.Stations.Contains(Station.StationId))
        {
            reportParameters.Stations.Add(Station.StationId);
        }

        ChartTitle = "Number of Overloaded Vehicle " + "( " + reportParameters.DateStart.ToString("dd MMM yyy") + " to " + reportParameters.DateEnd.AddDays(-1).ToString("dd MMM yyy") + " )";
        XAxisTitle = "Number of Vehicles (Units)";
        report = await loadService.GetHourlyOverloadedReport(reportParameters);
        if (report.Item2)
        {
            if (report.Item1.Count() > 0)
            {
                ChartData = report.Item1;
                YAxisTitle = "Hourly";
            }
            else
            {
                Summary = "No value is available";
            }
        }
        else
        {
            Summary = report.Item3;
        }
     
    }
}
