@page "/configuration"
@using BOL;
@using Services;
@inject IConfigurationService configurationService
@inject AuthenticationStateProvider authStateProvider
@inject IStringLocalizer<Locales.Reports> localizer

<PageTitleComponent Title="@localizer["ReportConfiguration.Title"]"></PageTitleComponent>

@if (configuration == null)
{
    <Loader />
}
else
{
    <div class="card card-primary card-outline">
        <div class="card-body">
            <EditForm Model="@configuration" OnValidSubmit=@OnValidSubmit OnInvalidSubmit="@OnInvalidSubmit">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            @if (editConfiguration)
                            {
                                <label for="numberofAxle" class="form-label">@localizer["MaximumAxleNumber"]</label>
                                <input type="number" @bind="configuration.NumberOfAxle" required class="form-control" placeholder="Maximum Axle Number" id="numberofAxle" min="1" />
                                <ValidationMessage For="() => configuration.NumberOfAxle" />
                            }
                            else
                            {
                                <label for="numberofAxle" class="form-label">@localizer["MaximumAxleNumber"]</label>
                                <label class="form-control">@configuration.NumberOfAxle</label>
                            }
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            @if (editConfiguration)
                            {
                                <label for="WheelBaseMax" class="form-label">@localizer["MaximumWheelBase"]</label>
                                <input type="number" @bind="configuration.WheelBaseMaximum" required class="form-control" placeholder="WheelBase Maximum" id="WheelBaseMax" min="1" />
                                <ValidationMessage For="() => configuration.WheelBaseMaximum" />
                            }
                            else
                            {
                                <label for="WheelBaseMax" class="form-label">@localizer["MaximumWheelBase"]</label>
                                <label class="form-control">@configuration.WheelBaseMaximum</label>
                            }
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            @if (editConfiguration)
                            {
                                <label for="startDate" class="form-label">@localizer["SystemStartDate"]</label>
                                <input type="date" @bind="configuration.SystemStartDate" required class="form-control" placeholder="System Start Date" id="startDate" />
                                <ValidationMessage For="() => configuration.SystemStartDate" />
                            }
                            else
                            {
                                <label for="startDate" class="form-label">@localizer["SystemStartDate"]</label>
                                <label class="form-control">@configuration.SystemStartDate.ToString("dd MMM yy")</label>
                            }
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="form-control btn-group p-0">
                                @if (!editConfiguration)
                                {
                                    <span class="btn btn-primary" @onclick="ToggleEdit">Edit</span>
                                }
                                else
                                {
                                    <button class="btn btn-primary" type="submit">Save</button>
                                    <span class="btn btn-primary" role="button" @onclick="Cancel">Cancel</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </EditForm>

            @if (!string.IsNullOrEmpty(summary))
            {
                <label class="error">@summary</label>
            }
        </div>
    </div>
    <div class="card card-primary card-outline">
        <div class="card-body">
            <h3 class="card-header">Allowed Weight 
                @if(!weightAddEnabled && !weightEditEnabled)
                {
                    <span class="btn btn-primary" @onclick="AddWeight"><i class="fa fa-plus"></i> Add New</span>
                }
            </h3>
            @if (weightAddEnabled || weightEditEnabled)
            {
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            <label for="axleNumber" class="form-label">Number of Axle</label>
                            @if (weightEditEnabled)
                            {
                                <label class="form-control">@selectedWeight.AxleNumber</label>
                            }
                            else
                            {
                                <input type="number" max="" class="form-control" @bind="selectedWeight.AxleNumber" />
                            }
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            <label for="allowedWeight" class="form-label">Allowed Weight</label>
                            <input type="number" @bind="selectedWeight.AllowedWeight" required class="form-control" placeholder="Allowed Weight" min="1000" />
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="form-control btn-group p-0">
                                @if (weightEditEnabled)
                                {
                                    <span class="btn btn-primary" @onclick="UpdateAlloweWeight">Update</span>
                                }
                                else
                                {
                                    <span class="btn btn-primary" @onclick="AddAlloweWeight">Add</span>
                                }
                                <span class="btn btn-primary" @onclick="CancelWeightEdit">Cancel</span>
                            </div>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(summaryWeightEdit))
                    {
                        <div class="col-md-3 col-sm-6">
                            <label>&nbsp;</label>
                            <div class="form-group">
                                <span class="form-control p-0" style="border: None">
                                    <p class="text-danger">@summaryWeightEdit</p>
                                </span>
                            </div>
                        </div>
                    }
                </div>
            }
            @if (overloadWeights is not null)
            {
                <table class="table table-stripped">
                    <thead>
                        <tr>
                            <th class="text-center">Number of Axle</th>
                            <th class="text-right">Allowed Weight (kg)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (ConfigurationOverloadWeight item in overloadWeights.OrderBy(w => w.AxleNumber))
                        {
                            <tr>
                                <td class="text-center">@item.AxleNumber</td>
                                <td class="text-right">@item.AllowedWeight.ToString("N0")</td>
                                <td class="text-center"><span class="btn btn-primary" @onclick="(() => EditWeight(item.AxleNumber))" title="Edit allowed weight for number of axle @item.AxleNumber"><i class="fa fa-edit"></i></span></td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-danger">Allowed weights not found</p>
            }
        </div>
    </div>
}

@code {
    private Configuration configuration { get; set; } = new();
    private User currentUser { get; set; }
    private bool editConfiguration { get; set; } = false;
    private bool trigger { get; set; } = false;
    private string summary { get; set; } = string.Empty;

    private List<ConfigurationOverloadWeight> overloadWeights { get; set; }
    private bool weightEditEnabled { get; set; } = false;
    private bool weightAddEnabled { get; set; } = false;
    private ConfigurationOverloadWeight selectedWeight { get; set; }
    private string summaryWeightEdit { get; set; } = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        var customStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
        currentUser = await customStateProvider.GetAuthorizedUser();

        configuration = await configurationService.GetConfiguration();
        if (configuration == null)
        {
            configuration = new Configuration();
            editConfiguration = true;
            trigger = true;
        }

        overloadWeights = (await configurationService.GetOverloadWeights()).ToList();
    }

    void OnInvalidSubmit()
    {
        summary = "Please enter valid data";
    }

    async Task OnValidSubmit(EditContext editContext)
    {
        summary = "";

        if (editConfiguration && trigger)
        {
            if (await configurationService.InsertConfiguration(configuration, currentUser))
            {
                summary = "Configuration added successfully";
            }
            else
            {
                summary = "Failed to add configuration";
            }
        }
        else
        {
            await configurationService.UpdateConfiguration(configuration, currentUser);
            summary = "Configuration updated successfully";
        }
        editConfiguration = false;
    }
    private async Task Cancel()
    {
        configuration = await configurationService.GetConfiguration();
        summary = "";
        editConfiguration = false;
    }
    void ToggleEdit()
    {
        summary = "";
        editConfiguration = !editConfiguration;
    }

    private void AddWeight()
    {
        weightAddEnabled = true;
        weightEditEnabled = false;
        summaryWeightEdit = string.Empty;
        selectedWeight = new();
        selectedWeight.AxleNumber = overloadWeights.Max(w=>w.AxleNumber) + 1;
        selectedWeight.AllowedWeight = 0;
    }
    private void EditWeight(int numberOfAxle)
    {
        weightEditEnabled = true;
        weightAddEnabled = false;
        summaryWeightEdit = string.Empty;
        selectedWeight = new();
        selectedWeight.AxleNumber = numberOfAxle;
        if (overloadWeights.Any(w => w.AxleNumber == numberOfAxle))
        {
            selectedWeight.AllowedWeight = overloadWeights.FirstOrDefault(w => w.AxleNumber == numberOfAxle).AllowedWeight;
        }
    }
    private async Task UpdateAlloweWeight()
    {
        if (selectedWeight.AllowedWeight > 0)
        {
            if (await configurationService.UpdateOverloadWeight(selectedWeight, currentUser))
            {
                overloadWeights.FirstOrDefault(w => w.AxleNumber == selectedWeight.AxleNumber).AllowedWeight = selectedWeight.AllowedWeight;
            }
        }
        else
        {
            summaryWeightEdit = "Allowed weight must be greater then 0";
        }
    }
    private async Task AddAlloweWeight()
    {
        if (selectedWeight.AllowedWeight > 0)
        {
            if (overloadWeights.Any(w => w.AxleNumber == selectedWeight.AxleNumber))
            {
                summaryWeightEdit = "Axle number already exists";
            }
            else
            {
                try
                {
                    if (await configurationService.InsertOverloadWeight(selectedWeight, currentUser))
                    {
                        overloadWeights.Add(new ConfigurationOverloadWeight() { AxleNumber = selectedWeight.AxleNumber, AllowedWeight = selectedWeight.AllowedWeight });
                    }
                    else
                    {
                        summaryWeightEdit = "Allowed weight add failed";
                    }
                }
                catch (Exception ex)
                {
                    summaryWeightEdit = "Allowed weight add failed. Error: " + ex.Message;
                    throw;
                }
            }            
        }
        else
        {
            summaryWeightEdit = "Allowed weight must be greater then 0";
        }
    }
    private void CancelWeightEdit()
    {
        weightEditEnabled = false;
        weightAddEnabled = false;
    }
}
