@using System
@using BOL
@using Services
@rendermode InteractiveServer
@inject AuthenticationStateProvider authStateProvider
@inject IUserActivityService userActivityService
@inject IStationService stationService
@inject IStringLocalizer<Locales.Resource> localizerResource
@inject IStringLocalizer<Locales.Station> localizer
@inject IAppState appState
@inject NavigationManager navigation

<PageTitleComponent Title="@localizer["StationManagement"]"></PageTitleComponent>

@if (station is null)
{
    <Loader />
}
else
{
    <EditForm Model="@station" OnValidSubmit=@OnValidSubmit OnInvalidSubmit="@OnInvalidSubmit" FormName="Stations" method="post">
        <DataAnnotationsValidator />
        <div class="card card-primary card-outline">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-sm-12">
                        <div class="form-group">
                            @if (Mode == FormMode.Details)
                            {
                                <label for="name" class="form-label">@localizer["Name"]</label>
                                <label class="form-control" style="max-width:auto; height:fit-content">@station.StationName</label>
                            }
                            else
                            {
                                <label for="name" class="form-label">@localizer["Name"]</label>
                                <input type="text" @bind-value="station.StationName" required class="form-control" placeholder="@localizer["Name"]" id="name" min="5" maxlength="45" />
                                <ValidationMessage For="() => station.StationName" />
                            }
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                        <div class="form-group">
                            @if (Mode == FormMode.Details)
                            {
                                <label for="authkey" class="form-label">@localizer["AuthKey"]</label>
                                <label class="form-control">@station.AuthKey</label>
                            }
                            else
                            {
                                <label for="authkey" class="form-label">@localizer["AuthKey"]</label>
                                <div class="input-group mb-3">
                                    <input type="text" @bind-value="station.AuthKey" required class="form-control" placeholder="@localizer["AuthKey"]" aria-label="API Key" id="authkey" aria-describedby="button-addon2" maxlength="20" />
                                    <span class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="button-addon2" @onclick="GenerateKey">@localizer["GenerateKey"]</button>
                                    </span>
                                </div>
                                <ValidationMessage For="() => station.AuthKey" />
                            }
                        </div>
                    </div>
                    <div class="col-md-8 col-sm-8">
                        <div class="form-group">
                            @if (Mode == FormMode.Details)
                            {
                                <label for="address" class="form-label">@localizer["Address"]</label>
                                <label class="form-control" style="max-width:auto; height:fit-content">@station.Address</label>
                            }
                            else
                            {
                                <label for="address" class="form-label">@localizer["Address"]</label>
                                <input type="text" @bind-value="station.Address" required class="form-control" placeholder="@localizer["Address"]" id="address" min="5" maxlength="300" />
                                <ValidationMessage For="() => station.Address" />
                            }
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-4">
                        <div class="form-group">
                            <label for="chkUpbound" class="form-label">Upbound/Downbound</label>
                            <div class="form-control">
                                <div class="icheck-primary d-inline">
                                    @* <input type="checkbox" id="checkboxPrimary1" checked=""> *@
                                    <input type="checkbox" id="chkUpbound" checked="@station.IsUpbound" @onchange="@(() => station.IsUpbound = !station.IsUpbound)" />
                                    <label for="chkUpbound">Is Upbound?</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                        <div class="form-group">
                            @if (Mode == FormMode.Details)
                            {
                                <label for="MapX" class="form-label">@localizer["MapX"]</label>
                                <label class="form-control">@station.MapX</label>
                            }
                            else
                            {
                                <label for="MapX" class="form-label">@localizer["MapX"]</label>
                                <input type="number" step="0.1" @bind-value="station.MapX" class="form-control" placeholder="@localizer["MapX"]" aria-label="Map X Coordinate" id="MapX" min="0" />
                                <ValidationMessage For="() => station.MapX" />
                            }
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                        <div class="form-group">
                            @if (Mode == FormMode.Details)
                            {
                                <label for="MapY" class="form-label">@localizer["MapY"]</label>
                                <label class="form-control">@station.MapY</label>
                            }
                            else
                            {
                                <label for="MapY" class="form-label">@localizer["MapY"]</label>
                                <input type="number" step="0.1" @bind-value="station.MapY" class="form-control" placeholder="@localizer["MapY"]" aria-label="Map Y Coordinate" id="MapY" min="0" />
                                <ValidationMessage For="() => station.MapY" />
                            }
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="col-md-12 col-sm-12">
                        <div class="btn-group">
                            @if (Mode == FormMode.Details)
                            {
                                string editLink = "/station/edit/" + station.StationId;
                                <NavLink class="btn btn-primary" href="@editLink">@localizerResource["Button.Edit"]</NavLink>
                            }
                            else
                            {
                                <button class="btn btn-primary" type="submit">@(Mode == FormMode.Add ? @localizerResource["Button.Save"] : @localizerResource["Button.Update"])</button>
                            }
                            <NavLink class="btn btn-primary" href="/station">@localizerResource["Button.Cancel"]</NavLink>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
}

@code {
    [Parameter]
    // [SupplyParameterFromForm(FormName = "Users")]
    public Station station { get; set; } = new();
    [Parameter]
    public FormMode Mode { get; set; } = FormMode.Details;
    private User currentUser { get; set; }

    void OnInvalidSubmit()
    {
        Notification notification = new("Please enter valid data", Notification.NotificationType.Warning);
        appState.SetNotification(this, notification);
    }
    async Task OnValidSubmit(EditContext editContext)
    {
        var customStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
        currentUser = await customStateProvider.GetAuthorizedUser();
        Notification notification = new();
        bool isSuccess = false;

        if (Mode == FormMode.Edit)
        {
            if (await stationService.Update(station))
            {
                notification.Type = Notification.NotificationType.Success;
                notification.Message = "Station Updated Successfully";
                isSuccess = true;
                await userActivityService.InsertUserActivity(new UserActivity { UserId = currentUser.Id, DateTime = DateTime.Now, Description = station.StationName + notification.Message, Activity = "Update" });
            }
            else
            {
                notification.Type = Notification.NotificationType.Failure;
                notification.Message = "Error: Station Update Failed";
            }
        }
        else
        {
            if (await stationService.Add(station))
            {
                notification.Type = Notification.NotificationType.Success;
                notification.Message = "Station Added Successfully";
                isSuccess = true;
                await userActivityService.InsertUserActivity(new UserActivity { UserId = currentUser.Id, DateTime = DateTime.Now, Description = station.StationName + notification.Message, Activity = "Insert" });
            }
            else
            {
                notification.Type = Notification.NotificationType.Failure;
                notification.Message = "Error: Station Add Failed";
            }
        }

        appState.SetNotification(this, notification);
        navigation.NavigateTo("station");
    }

    private void GenerateKey()
    {
        station.AuthKey = stationService.GenerateKey();
    }
}
